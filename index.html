<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼ãƒ»ãƒãƒˆãƒªãƒƒã‚¯ã‚¹</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .auth-section {
        padding: 20px;
        background: #f8f9fa;
        position: relative;
      }

      .login-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
      }

      .login-btn:hover {
        background: #357ae8;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.6);
      }

      .user-info {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 15px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .user-info span {
        font-size: 1em;
        font-weight: 500;
        color: #333;
        white-space: nowrap;
      }

      .sync-btn {
        background: #34a853;
        color: white;
        border: none;
        padding: 10px 25px;
        font-size: 0.9em;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .sync-btn:hover {
        background: #2d8f47;
        transform: translateY(-2px);
      }

      .logout-btn {
        background: #ea4335;
        color: white;
        border: none;
        padding: 10px 25px;
        font-size: 0.9em;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: #d33b2c;
        transform: translateY(-2px);
      }

      .matrix-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 120px);
        min-height: 600px;
        gap: 2px;
        background: #ddd;
      }

      .quadrant {
        background: white;
        padding: 10px;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        transition: all 0.3s;
        max-height: 100%;
      }

      .quadrant #tasks1,
      .quadrant #tasks2,
      .quadrant #tasks3,
      .quadrant #tasks4 {
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
      }

      .quadrant::-webkit-scrollbar {
        width: 8px;
      }

      .quadrant::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .quadrant::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .quadrant::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .quadrant:hover {
        background: #f8f9fa;
      }

      .quadrant-header {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .add-task-btn {
        background: #667eea;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        margin-left: 10px;
      }

      .add-task-btn:hover {
        background: #5a67d8;
        transform: scale(1.1);
      }

      .task-creation-form {
        background: #f8f9fa;
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        display: none;
      }

      .task-creation-form.show {
        display: block;
      }

      .form-group {
        margin-bottom: 10px;
      }

      .form-group label {
        display: block;
        font-size: 0.9em;
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: inherit;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 60px;
      }

      .form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .form-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .form-btn.primary {
        background: #667eea;
        color: white;
      }

      .form-btn.primary:hover {
        background: #5a67d8;
      }

      .form-btn.secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .form-btn.secondary:hover {
        background: #cbd5e0;
      }

      .quadrant-1 {
        border-color: #e74c3c;
      }

      .quadrant-1 .quadrant-header {
        color: #e74c3c;
      }

      .quadrant-2 {
        border-color: #3498db;
      }

      .quadrant-2 .quadrant-header {
        color: #3498db;
      }

      .quadrant-3 {
        border-color: #f39c12;
      }

      .quadrant-3 .quadrant-header {
        color: #f39c12;
      }

      .quadrant-4 {
        border-color: #95a5a6;
      }

      .quadrant-4 .quadrant-header {
        color: #95a5a6;
      }

      .task-count {
        background: rgba(0, 0, 0, 0.1);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9em;
      }

      .task-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 6px 8px;
        margin: 4px;
        cursor: move;
        transition: all 0.2s;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        width: calc(20% - 8px);
        min-width: 150px;
        display: inline-block;
        vertical-align: top;
      }

      .task-item:hover {
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .task-item.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
      }

      .task-item.drag-over {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .task-title {
        font-size: 0.75em;
        font-weight: 500;
        margin-bottom: 4px;
        color: #333;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .task-notes {
        font-size: 0.65em;
        color: #666;
        margin-bottom: 4px;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .task-due {
        font-size: 0.6em;
        color: #999;
        margin-bottom: 4px;
      }

      .task-actions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      .complete-btn {
        background: #34a853;
        color: white;
        border: none;
        padding: 2px 8px;
        font-size: 0.6em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .complete-btn:hover {
        background: #2d8f47;
        transform: scale(1.05);
      }

      .edit-btn {
        background: #f39c12;
        color: white;
        border: none;
        padding: 2px 8px;
        font-size: 0.6em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 4px;
      }

      .edit-btn:hover {
        background: #e67e22;
        transform: scale(1.05);
      }

      .task-item.editing {
        background: #fff3cd;
        border: 2px solid #f39c12;
      }

      .task-edit-form {
        display: none;
        padding: 8px;
        background: #fff3cd;
        border-radius: 4px;
        margin: 4px 0;
      }

      .task-edit-form.show {
        display: block;
      }

      .task-edit-input {
        width: 100%;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 0.75em;
        margin-bottom: 4px;
        font-family: inherit;
      }

      .task-edit-textarea {
        width: 100%;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 0.65em;
        margin-bottom: 4px;
        font-family: inherit;
        resize: vertical;
        min-height: 40px;
      }

      .task-edit-actions {
        display: flex;
        gap: 4px;
        justify-content: flex-end;
      }

      .task-edit-btn {
        padding: 3px 8px;
        border: none;
        border-radius: 3px;
        font-size: 0.6em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .task-edit-btn.save {
        background: #28a745;
        color: white;
      }

      .task-edit-btn.save:hover {
        background: #218838;
      }

      .task-edit-btn.cancel {
        background: #6c757d;
        color: white;
      }

      .task-edit-btn.cancel:hover {
        background: #5a6268;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 1.1em;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
      }

      /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }

      .modal-title {
        font-size: 1.5em;
        font-weight: 600;
        color: #333;
        flex: 1;
      }

      .modal-close {
        background: #ea4335;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .modal-close:hover {
        background: #d33b2c;
        transform: scale(1.1);
      }

      .modal-body {
        color: #333;
        line-height: 1.6;
      }

      .modal-section {
        margin-bottom: 20px;
      }

      .modal-section-label {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
        font-size: 0.9em;
      }

      .modal-section-content {
        color: #666;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .modal-due {
        color: #999;
        font-size: 0.9em;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          border-radius: 10px;
        }

        .auth-section {
          padding: 15px;
        }

        .user-info {
          justify-content: center;
          gap: 10px;
        }

        .matrix-container {
          grid-template-columns: 1fr;
          grid-template-rows: repeat(4, auto);
          height: auto;
          min-height: auto;
          gap: 10px;
        }

        .quadrant {
          min-height: 200px;
          max-height: none;
          padding: 15px;
        }

        .quadrant-header {
          font-size: 1.1em;
          margin-bottom: 10px;
          flex-wrap: wrap;
          gap: 10px;
        }

        .task-item {
          width: 100%;
          min-width: auto;
          margin: 5px 0;
        }

        .task-title {
          font-size: 0.85em;
        }

        .task-notes {
          font-size: 0.75em;
        }

        .task-due {
          font-size: 0.7em;
        }

        .add-task-btn {
          width: 20px;
          height: 20px;
          font-size: 1em;
        }

        .task-creation-form {
          padding: 10px;
          margin: 5px 0;
        }

        .form-group input,
        .form-group textarea {
          font-size: 16px; /* iOS zoom prevention */
        }

        .task-edit-input,
        .task-edit-textarea {
          font-size: 16px; /* iOS zoom prevention */
        }

        .task-actions {
          gap: 6px;
        }

        .complete-btn,
        .edit-btn {
          padding: 4px 10px;
          font-size: 0.7em;
        }

        .modal-content {
          margin: 20px;
          max-height: calc(100vh - 40px);
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 5px;
        }

        .quadrant {
          min-height: 150px;
          padding: 10px;
        }

        .quadrant-header {
          font-size: 1em;
        }

        .task-item {
          padding: 8px;
        }

        .task-title {
          font-size: 0.8em;
        }

        .task-notes {
          font-size: 0.7em;
        }

        .complete-btn,
        .edit-btn {
          padding: 3px 8px;
          font-size: 0.65em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="auth-section" id="authSection">
        <div id="loginArea">
          <button class="login-btn" onclick="handleAuthClick()">
            Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
        <div id="userArea" style="display: none">
          <div class="user-info">
            <img id="userImage" src="" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒ" />
            <span id="userName"></span>
            <button class="sync-btn" onclick="handleSync()">ğŸ”„ åŒæœŸ</button>
            <button class="logout-btn" onclick="handleSignout()">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>
      </div>

      <div id="errorArea" style="display: none"></div>

      <div class="matrix-container" id="matrixContainer" style="display: none">
        <div class="quadrant quadrant-1" id="quadrant1" data-quadrant="1">
          <div class="quadrant-header">
            <span>ğŸ”´ é‡è¦ã‹ã¤ç·Šæ€¥</span>
            <div style="display: flex; align-items: center">
              <span class="task-count" id="count1">0</span>
              <button
                class="add-task-btn"
                onclick="showTaskCreationForm(1)"
                title="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
              >
                +
              </button>
            </div>
          </div>
          <div class="task-creation-form" id="taskForm1">
            <div class="form-group">
              <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
              <input
                type="text"
                id="taskTitle1"
                placeholder="ä»Šã™ãå¯¾å¿œãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..."
              />
            </div>
            <div class="form-group">
              <label>è©³ç´°</label>
              <textarea
                id="taskNotes1"
                placeholder="è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
              ></textarea>
            </div>
            <div class="form-group">
              <label>æœŸé™</label>
              <input type="date" id="taskDue1" />
            </div>
            <div class="form-actions">
              <button
                class="form-btn secondary"
                onclick="hideTaskCreationForm(1)"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button class="form-btn primary" onclick="createTask(1)">
                ä½œæˆ
              </button>
            </div>
          </div>
          <div id="tasks1"></div>
        </div>

        <div class="quadrant quadrant-2" id="quadrant2" data-quadrant="2">
          <div class="quadrant-header">
            <span>ğŸ”µ é‡è¦ã ãŒç·Šæ€¥ã§ãªã„</span>
            <div style="display: flex; align-items: center">
              <span class="task-count" id="count2">0</span>
              <button
                class="add-task-btn"
                onclick="showTaskCreationForm(2)"
                title="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
              >
                +
              </button>
            </div>
          </div>
          <div class="task-creation-form" id="taskForm2">
            <div class="form-group">
              <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
              <input
                type="text"
                id="taskTitle2"
                placeholder="é•·æœŸçš„ãªç›®æ¨™ã«ç¹‹ãŒã‚‹ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..."
              />
            </div>
            <div class="form-group">
              <label>è©³ç´°</label>
              <textarea
                id="taskNotes2"
                placeholder="è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
              ></textarea>
            </div>
            <div class="form-group">
              <label>æœŸé™</label>
              <input type="date" id="taskDue2" />
            </div>
            <div class="form-actions">
              <button
                class="form-btn secondary"
                onclick="hideTaskCreationForm(2)"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button class="form-btn primary" onclick="createTask(2)">
                ä½œæˆ
              </button>
            </div>
          </div>
          <div id="tasks2"></div>
        </div>

        <div class="quadrant quadrant-3" id="quadrant3" data-quadrant="3">
          <div class="quadrant-header">
            <span>ğŸŸ¡ é‡è¦ã§ãªã„ãŒç·Šæ€¥</span>
            <div style="display: flex; align-items: center">
              <span class="task-count" id="count3">0</span>
              <button
                class="add-task-btn"
                onclick="showTaskCreationForm(3)"
                title="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
              >
                +
              </button>
            </div>
          </div>
          <div class="task-creation-form" id="taskForm3">
            <div class="form-group">
              <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
              <input
                type="text"
                id="taskTitle3"
                placeholder="ä»–ã®äººã«å§”ä»»ã§ãã‚‹ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›..."
              />
            </div>
            <div class="form-group">
              <label>è©³ç´°</label>
              <textarea
                id="taskNotes3"
                placeholder="è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
              ></textarea>
            </div>
            <div class="form-group">
              <label>æœŸé™</label>
              <input type="date" id="taskDue3" />
            </div>
            <div class="form-actions">
              <button
                class="form-btn secondary"
                onclick="hideTaskCreationForm(3)"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button class="form-btn primary" onclick="createTask(3)">
                ä½œæˆ
              </button>
            </div>
          </div>
          <div id="tasks3"></div>
        </div>

        <div class="quadrant quadrant-4" id="quadrant4" data-quadrant="4">
          <div class="quadrant-header">
            <span>âšª é‡è¦ã§ã‚‚ç·Šæ€¥ã§ã‚‚ãªã„</span>
            <div style="display: flex; align-items: center">
              <span class="task-count" id="count4">0</span>
              <button
                class="add-task-btn"
                onclick="showTaskCreationForm(4)"
                title="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
              >
                +
              </button>
            </div>
          </div>
          <div class="task-creation-form" id="taskForm4">
            <div class="form-group">
              <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
              <input
                type="text"
                id="taskTitle4"
                placeholder="æœ¬å½“ã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‹æ¤œè¨ã—ã¦ãã ã•ã„..."
              />
            </div>
            <div class="form-group">
              <label>è©³ç´°</label>
              <textarea
                id="taskNotes4"
                placeholder="è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
              ></textarea>
            </div>
            <div class="form-group">
              <label>æœŸé™</label>
              <input type="date" id="taskDue4" />
            </div>
            <div class="form-actions">
              <button
                class="form-btn secondary"
                onclick="hideTaskCreationForm(4)"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button class="form-btn primary" onclick="createTask(4)">
                ä½œæˆ
              </button>
            </div>
          </div>
          <div id="tasks4"></div>
        </div>
      </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="taskModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle"></div>
          <button class="modal-close" onclick="closeTaskModal()">Ã—</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>

    <script>
      // âš ï¸ ã“ã“ã«å–å¾—ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¨­å®šã—ã¦ãã ã•ã„
      const CLIENT_ID =
        "43001239066-v2k8cue54mtsj512bphu24tjksbdm2uo.apps.googleusercontent.com";
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest",
      ];
      const SCOPES = "https://www.googleapis.com/auth/tasks";

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
      const STORAGE_KEY = "taskMatrixQuadrants";

      let gapiInitialized = false;
      let gisInitialized = false;
      let tokenClient = null;
      let tasks = []; // Google Tasksã‹ã‚‰èª­ã¿è¾¼ã‚“ã å…ƒã®ã‚¿ã‚¹ã‚¯
      let taskQuadrants = {}; // ã‚¿ã‚¹ã‚¯ID -> è±¡é™ç•ªå·ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼‰

      // Google API ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿
      function onGapiLoaded() {
        gapi.load("client", initializeGapiClient);
      }

      function onGisLoaded() {
        try {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: "", // å¾Œã§è¨­å®š
          });
          gisInitialized = true;
          maybeEnableButtons();
        } catch (error) {
          showError(
            "Google Identity Services ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message
          );
        }
      }

      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
          });
          gapiInitialized = true;
          maybeEnableButtons();
        } catch (error) {
          showError(
            "Google API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message
          );
        }
      }

      function maybeEnableButtons() {
        if (gapiInitialized && gisInitialized) {
          console.log("Google API ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ");
          // åˆæœŸåŒ–å®Œäº†å¾Œã«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦è¡Œ
          tryAutoLogin();
        }
      }

      // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
      function isTokenValid(token) {
        if (!token || !token.access_token) {
          return false;
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
        const now = Date.now();
        const expiresAt = token.expires_at || now + 3600000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“

        return now < expiresAt;
      }

      // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦è¡Œ
      async function tryAutoLogin() {
        try {
          const token = gapi.client.getToken();
          if (isTokenValid(token)) {
            console.log(
              "æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
            );
            await loadTasks();
            return true;
          }
        } catch (error) {
          console.log("è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
        return false;
      }

      // èªè¨¼å‡¦ç†
      function handleAuthClick() {
        if (CLIENT_ID === "YOUR_CLIENT_ID_HERE") {
          showError(
            "ã‚¨ãƒ©ãƒ¼: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚index.htmlã®CLIENT_IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        if (!gapiInitialized || !gisInitialized) {
          showError(
            "Google API ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        if (!tokenClient) {
          showError(
            "èªè¨¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        if (typeof google === "undefined" || !google.accounts) {
          showError(
            "Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            showError("èªè¨¼ã‚¨ãƒ©ãƒ¼: " + resp.error);
            return;
          }

          // ãƒˆãƒ¼ã‚¯ãƒ³ã«æœ‰åŠ¹æœŸé™ã‚’è¨­å®š
          const token = gapi.client.getToken();
          if (token) {
            token.expires_at = Date.now() + (resp.expires_in || 3600) * 1000;
            gapi.client.setToken(token);
          }

          await loadTasks();
        };

        try {
          if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({ prompt: "consent" });
          } else {
            tokenClient.requestAccessToken({ prompt: "" });
          }
        } catch (error) {
          showError("èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      async function handleSignout() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚èªè¨¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
        try {
          localStorage.removeItem("gapi.client.token");
        } catch (error) {
          console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:", error);
        }

        document.getElementById("loginArea").style.display = "block";
        document.getElementById("userArea").style.display = "none";
        document.getElementById("matrixContainer").style.display = "none";
        tasks = [];
        taskQuadrants = {};
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è±¡é™æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
      function loadQuadrantsFromStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            taskQuadrants = JSON.parse(stored);
          } else {
            taskQuadrants = {};
          }
        } catch (error) {
          console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
          taskQuadrants = {};
        }
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è±¡é™æƒ…å ±ã‚’ä¿å­˜
      function saveQuadrantsToStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(taskQuadrants));
        } catch (error) {
          console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      // åŒæœŸãƒœã‚¿ãƒ³ã®å‡¦ç†
      async function handleSync() {
        await loadTasks();
      }

      // ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿
      async function loadTasks() {
        try {
          // ã¾ãšãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
          const matrixContainer = document.getElementById("matrixContainer");
          if (matrixContainer) {
            matrixContainer.style.display = "grid";
            showLoading();
          }

          // ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—
          let allTaskLists = [];
          let nextPageToken = null;

          do {
            const taskListsResponse = await gapi.client.tasks.tasklists.list({
              maxResults: 100,
              pageToken: nextPageToken || undefined,
            });

            if (taskListsResponse.result.items) {
              allTaskLists = allTaskLists.concat(
                taskListsResponse.result.items
              );
            }
            nextPageToken = taskListsResponse.result.nextPageToken;
          } while (nextPageToken);

          // 4ã¤ã®ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’ç¢ºèªãƒ»ä½œæˆ
          const matrixListNames = [
            "é‡è¦ã‹ã¤ç·Šæ€¥",
            "é‡è¦ã ãŒç·Šæ€¥ã§ãªã„",
            "é‡è¦ã§ãªã„ãŒç·Šæ€¥",
            "é‡è¦ã§ã‚‚ç·Šæ€¥ã§ã‚‚ãªã„",
          ];

          // å¿…è¦ãªãƒªã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          for (const listName of matrixListNames) {
            const existingList = allTaskLists.find(
              (list) => list.title === listName
            );
            if (!existingList) {
              const createResponse = await gapi.client.tasks.tasklists.insert({
                title: listName,
              });
              allTaskLists.push(createResponse.result);
            }
          }

          // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹é–¢é€£ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã®ã¿ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
          let allTasks = [];
          for (const taskList of allTaskLists) {
            // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹é–¢é€£ã®ãƒªã‚¹ãƒˆã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
            if (matrixListNames.includes(taskList.title)) {
              let nextTaskPageToken = null;
              do {
                const tasksResponse = await gapi.client.tasks.tasks.list({
                  tasklist: taskList.id,
                  showCompleted: false,
                  showHidden: false,
                  maxResults: 100,
                  pageToken: nextTaskPageToken || undefined,
                });

                if (tasksResponse.result.items) {
                  // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆIDã‚’å„ã‚¿ã‚¹ã‚¯ã«ä¿å­˜
                  const tasksWithListId = tasksResponse.result.items.map(
                    (task) => ({
                      ...task,
                      taskListId: taskList.id,
                      taskListTitle: taskList.title,
                    })
                  );
                  allTasks = allTasks.concat(tasksWithListId);
                }
                nextTaskPageToken = tasksResponse.result.nextPageToken;
              } while (nextTaskPageToken);
            }
          }

          tasks = allTasks;
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è±¡é™æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
          loadQuadrantsFromStorage();

          // åŒæœŸæ™‚ï¼šç¾åœ¨èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ãƒãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
          // ã“ã‚Œã«ã‚ˆã‚Šã€å‰Šé™¤ã—ãŸã‚¿ã‚¹ã‚¯ãŒåŒæœŸå¾Œã«å†è¡¨ç¤ºã•ã‚Œã‚‹
          tasks.forEach((task) => {
            if (taskQuadrants[task.id] === "deleted") {
              delete taskQuadrants[task.id];
            }
          });

          // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆåã«åŸºã¥ã„ã¦è±¡é™ã‚’è‡ªå‹•åˆ¤å®š
          tasks.forEach((task) => {
            const quadrant = getQuadrantFromTaskListTitle(task.taskListTitle);
            if (quadrant) {
              taskQuadrants[task.id] = quadrant;
            }
          });

          saveQuadrantsToStorage();

          displayTasks();
          await displayUserInfo();
        } catch (error) {
          hideLoading();
          showError("ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          console.error("ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      async function displayUserInfo() {
        try {
          // Google Identity Services APIã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
          const token = gapi.client.getToken();
          if (token) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«OAuth2 userinfoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
            try {
              const userInfo = await fetch(
                "https://www.googleapis.com/oauth2/v2/userinfo",
                {
                  headers: {
                    Authorization: `Bearer ${token.access_token}`,
                  },
                }
              );

              if (userInfo.ok) {
                const userData = await userInfo.json();
                const userNameEl = document.getElementById("userName");
                const userImageEl = document.getElementById("userImage");

                if (userNameEl) {
                  userNameEl.textContent =
                    userData.name || userData.email || "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
                }
                if (userImageEl) {
                  if (userData.picture) {
                    userImageEl.src = userData.picture;
                    userImageEl.style.display = "block";
                  } else {
                    userImageEl.style.display = "none";
                  }
                }
              } else {
                throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
              }
            } catch (error) {
              console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
              const userNameEl = document.getElementById("userName");
              const userImageEl = document.getElementById("userImage");
              if (userNameEl) {
                userNameEl.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
              }
              if (userImageEl) {
                userImageEl.style.display = "none";
              }
            }
          } else {
            // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
            const userNameEl = document.getElementById("userName");
            const userImageEl = document.getElementById("userImage");
            if (userNameEl) {
              userNameEl.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
            }
            if (userImageEl) {
              userImageEl.style.display = "none";
            }
          }
        } catch (error) {
          console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          const userNameEl = document.getElementById("userName");
          const userImageEl = document.getElementById("userImage");
          if (userNameEl) {
            userNameEl.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
          }
          if (userImageEl) {
            userImageEl.style.display = "none";
          }
        }

        document.getElementById("loginArea").style.display = "none";
        document.getElementById("userArea").style.display = "block";
        document.getElementById("matrixContainer").style.display = "grid";
      }

      function displayTasks() {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
        hideLoading();

        // å„è±¡é™ã‚’ã‚¯ãƒªã‚¢
        ["1", "2", "3", "4"].forEach((q) => {
          const tasksContainer = document.getElementById(`tasks${q}`);
          if (tasksContainer) {
            tasksContainer.innerHTML = "";
          }
        });

        // ã‚¿ã‚¹ã‚¯ã‚’è±¡é™ã«åˆ†é¡ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ï¼‰
        // å‰Šé™¤ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚„å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºã—ãªã„
        tasks.forEach((task) => {
          const quadrant = getTaskQuadrant(task.id);
          if (quadrant && quadrant !== "deleted" && quadrant !== "completed") {
            addTaskToQuadrant(task, quadrant);
          }
          // è±¡é™ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºã—ãªã„ï¼ˆåŒæœŸæ™‚ã«åˆ†æ•£ã•ã‚Œã‚‹ï¼‰
        });

        updateCounts();
        setupDragAndDrop();
      }

      // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆåã‹ã‚‰è±¡é™ç•ªå·ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
      function getQuadrantFromTaskListTitle(taskListTitle) {
        switch (taskListTitle) {
          case "é‡è¦ã‹ã¤ç·Šæ€¥":
            return "1";
          case "é‡è¦ã ãŒç·Šæ€¥ã§ãªã„":
            return "2";
          case "é‡è¦ã§ãªã„ãŒç·Šæ€¥":
            return "3";
          case "é‡è¦ã§ã‚‚ç·Šæ€¥ã§ã‚‚ãªã„":
            return "4";
          default:
            return null;
        }
      }

      function getTaskQuadrant(taskId) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è±¡é™æƒ…å ±ã‚’å–å¾—
        // å‰Šé™¤ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®å ´åˆã¯"deleted"ã‚’è¿”ã™
        return taskQuadrants[taskId];
      }

      function addTaskToQuadrant(task, quadrant) {
        const container = document.getElementById(`tasks${quadrant}`);
        const taskElement = createTaskElement(task);
        container.appendChild(taskElement);
      }

      function createTaskElement(task) {
        const div = document.createElement("div");
        div.className = "task-item";
        div.draggable = true;
        div.dataset.taskId = task.id;

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒœã‚¿ãƒ³ã‚„ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãï¼‰
        div.addEventListener("click", (e) => {
          // ãƒœã‚¿ãƒ³ã‚„ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ å†…ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
          if (
            !e.target.classList.contains("complete-btn") &&
            !e.target.closest(".complete-btn") &&
            !e.target.classList.contains("edit-btn") &&
            !e.target.closest(".edit-btn") &&
            !e.target.closest(".task-edit-form") &&
            !e.target.classList.contains("task-edit-btn")
          ) {
            showTaskModal(task);
          }
        });

        const title = document.createElement("div");
        title.className = "task-title";
        title.textContent = task.title || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰";
        div.appendChild(title);

        // notesã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆQUADRANTæƒ…å ±ã¯å«ã¾ã‚Œã¦ã„ãªã„ï¼‰
        if (task.notes) {
          const notes = document.createElement("div");
          notes.className = "task-notes";
          notes.textContent = task.notes;
          div.appendChild(notes);
        }

        if (task.due) {
          const due = document.createElement("div");
          due.className = "task-due";
          const dueDate = new Date(task.due);
          due.textContent = `æœŸé™: ${dueDate.toLocaleDateString("ja-JP")}`;
          div.appendChild(due);
        }

        const actions = document.createElement("div");
        actions.className = "task-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn";
        editBtn.textContent = "ç·¨é›†";
        editBtn.onclick = (e) => {
          e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã
          startEditTask(task);
        };
        actions.appendChild(editBtn);

        const completeBtn = document.createElement("button");
        completeBtn.className = "complete-btn";
        completeBtn.textContent = "å®Œäº†";
        completeBtn.onclick = (e) => {
          e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã
          completeTask(task.id, task.taskListId);
        };
        actions.appendChild(completeBtn);

        div.appendChild(actions);

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
        const editForm = document.createElement("div");
        editForm.className = "task-edit-form";
        editForm.id = `editForm-${task.id}`;

        editForm.innerHTML = `
          <input type="text" class="task-edit-input" id="editTitle-${
            task.id
          }" value="${escapeHtml(
          task.title || ""
        )}" placeholder="ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«" />
          <textarea class="task-edit-textarea" id="editNotes-${
            task.id
          }" placeholder="è©³ç´°">${escapeHtml(task.notes || "")}</textarea>
          <input type="date" class="task-edit-input" id="editDue-${
            task.id
          }" value="${task.due ? task.due.split("T")[0] : ""}" />
          <div class="task-edit-actions">
            <button class="task-edit-btn cancel" onclick="cancelEditTask('${
              task.id
            }')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="task-edit-btn save" onclick="saveEditTask('${
              task.id
            }')">ä¿å­˜</button>
          </div>
        `;

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’é˜²ã
        editForm.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        div.appendChild(editForm);

        return div;
      }

      function updateCounts() {
        ["1", "2", "3", "4"].forEach((q) => {
          const count = document.getElementById(`tasks${q}`).children.length;
          document.getElementById(`count${q}`).textContent = count;
        });
      }

      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
      function setupDragAndDrop() {
        const taskItems = document.querySelectorAll(".task-item");
        const quadrants = document.querySelectorAll(".quadrant");

        taskItems.forEach((item) => {
          item.addEventListener("dragstart", handleDragStart);
          item.addEventListener("dragend", handleDragEnd);
        });

        quadrants.forEach((quadrant) => {
          quadrant.addEventListener("dragover", handleDragOver);
          quadrant.addEventListener("drop", handleDrop);
          quadrant.addEventListener("dragenter", handleDragEnter);
          quadrant.addEventListener("dragleave", handleDragLeave);
        });
      }

      let draggedElement = null;

      function handleDragStart(e) {
        draggedElement = this;
        this.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", this.innerHTML);
      }

      function handleDragEnd(e) {
        this.classList.remove("dragging");
        document.querySelectorAll(".quadrant").forEach((q) => {
          q.classList.remove("drag-over");
        });
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = "move";
        return false;
      }

      function handleDragEnter(e) {
        this.classList.add("drag-over");
      }

      function handleDragLeave(e) {
        this.classList.remove("drag-over");
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        this.classList.remove("drag-over");

        if (draggedElement != null) {
          const taskId = draggedElement.dataset.taskId;
          const newQuadrant = this.dataset.quadrant;
          const task = tasks.find((t) => t.id === taskId);

          if (task) {
            // ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
            draggedElement.remove();
            addTaskToQuadrant(task, newQuadrant);
            updateCounts();
            setupDragAndDrop();

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            updateTaskQuadrant(taskId, newQuadrant);

            // Google Tasksã§ã‚‚å¯¾å¿œã™ã‚‹ãƒªã‚¹ãƒˆã«ç§»å‹•
            moveTaskToCorrectList(task, newQuadrant);
          }
        }

        return false;
      }

      function updateTaskQuadrant(taskId, quadrant) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è±¡é™æƒ…å ±ã‚’ä¿å­˜
        taskQuadrants[taskId] = quadrant;
        saveQuadrantsToStorage();
      }

      // è±¡é™ç•ªå·ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆåã‚’å–å¾—
      function getTaskListTitleFromQuadrant(quadrant) {
        switch (quadrant) {
          case "1":
            return "é‡è¦ã‹ã¤ç·Šæ€¥";
          case "2":
            return "é‡è¦ã ãŒç·Šæ€¥ã§ãªã„";
          case "3":
            return "é‡è¦ã§ãªã„ãŒç·Šæ€¥";
          case "4":
            return "é‡è¦ã§ã‚‚ç·Šæ€¥ã§ã‚‚ãªã„";
          default:
            return null;
        }
      }

      // Google Tasksã§ã‚¿ã‚¹ã‚¯ã‚’æ­£ã—ã„ãƒªã‚¹ãƒˆã«ç§»å‹•
      async function moveTaskToCorrectList(task, newQuadrant) {
        try {
          const targetListTitle = getTaskListTitleFromQuadrant(newQuadrant);
          if (!targetListTitle) return;

          // ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—
          const taskListsResponse = await gapi.client.tasks.tasklists.list({
            maxResults: 100,
          });

          if (!taskListsResponse.result.items) return;

          // å¯¾è±¡ã®ãƒªã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
          const targetList = taskListsResponse.result.items.find(
            (list) => list.title === targetListTitle
          );

          if (!targetList) return;

          // ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
          await gapi.client.tasks.tasks.delete({
            tasklist: task.taskListId,
            task: task.id,
          });

          // æ–°ã—ã„ãƒªã‚¹ãƒˆã«è¿½åŠ 
          await gapi.client.tasks.tasks.insert({
            tasklist: targetList.id,
            resource: {
              title: task.title,
              notes: task.notes,
              due: task.due,
            },
          });
        } catch (error) {
          console.error("ã‚¿ã‚¹ã‚¯ã®ç§»å‹•ã‚¨ãƒ©ãƒ¼:", error);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚UIã®æ›´æ–°ã¯ç¶™ç¶š
        }
      }

      async function completeTask(taskId, taskListId) {
        if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ")) {
          return;
        }

        try {
          // Google Tasksã§ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†çŠ¶æ…‹ã«ã™ã‚‹
          const updateRequest = {
            tasklist: taskListId,
            task: taskId,
            resource: {
              id: taskId,
              status: "completed",
            },
          };

          await gapi.client.tasks.tasks.update(updateRequest);

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆå®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          taskQuadrants[taskId] = "completed";
          saveQuadrantsToStorage();

          // è¡¨ç¤ºã‚’æ›´æ–°
          displayTasks();
        } catch (error) {
          showError(
            "ã‚¿ã‚¹ã‚¯ã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (error.message || error.toString())
          );
          console.error("ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      function showLoading() {
        const matrixContainer = document.getElementById("matrixContainer");
        if (!matrixContainer) return;

        // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã‚’å‰Šé™¤
        const existingLoading =
          matrixContainer.querySelector(".loading-overlay");
        if (existingLoading) {
          existingLoading.remove();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
        const loadingOverlay = document.createElement("div");
        loadingOverlay.className = "loading-overlay";
        loadingOverlay.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(255, 255, 255, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          font-size: 1.2em;
          color: #667eea;
        `;
        loadingOverlay.textContent = "ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
        matrixContainer.style.position = "relative";
        matrixContainer.appendChild(loadingOverlay);
      }

      function hideLoading() {
        const matrixContainer = document.getElementById("matrixContainer");
        if (!matrixContainer) return;
        const loadingOverlay =
          matrixContainer.querySelector(".loading-overlay");
        if (loadingOverlay) {
          loadingOverlay.remove();
        }
      }

      // ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      function showTaskModal(task) {
        const modal = document.getElementById("taskModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");

        if (!modal || !modalTitle || !modalBody) return;

        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
        modalTitle.textContent = task.title || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰";

        // æœ¬æ–‡ã‚’æ§‹ç¯‰
        let bodyHTML = "";

        // è©³ç´°ï¼ˆnotesï¼‰
        if (task.notes) {
          bodyHTML += `
            <div class="modal-section">
              <div class="modal-section-label">ğŸ“ è©³ç´°</div>
              <div class="modal-section-content">${escapeHtml(task.notes)}</div>
            </div>
          `;
        }

        // æœŸé™
        if (task.due) {
          const dueDate = new Date(task.due);
          bodyHTML += `
            <div class="modal-section">
              <div class="modal-section-label">ğŸ“… æœŸé™</div>
              <div class="modal-section-content modal-due">${dueDate.toLocaleDateString(
                "ja-JP",
                {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                  weekday: "long",
                }
              )}</div>
            </div>
          `;
        }

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆæƒ…å ±
        if (task.taskListTitle) {
          bodyHTML += `
            <div class="modal-section">
              <div class="modal-section-label">ğŸ“‹ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</div>
              <div class="modal-section-content">${escapeHtml(
                task.taskListTitle
              )}</div>
            </div>
          `;
        }

        // æœ¬æ–‡ãŒç©ºã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (!bodyHTML) {
          bodyHTML =
            '<div class="modal-section"><div class="modal-section-content">è©³ç´°æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>';
        }

        modalBody.innerHTML = bodyHTML;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.add("show");

        // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        modal.addEventListener("click", function closeOnOverlay(e) {
          if (e.target === modal) {
            closeTaskModal();
            modal.removeEventListener("click", closeOnOverlay);
          }
        });

        // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
        document.addEventListener("keydown", function closeOnEsc(e) {
          if (e.key === "Escape") {
            closeTaskModal();
            document.removeEventListener("keydown", closeOnEsc);
          }
        });
      }

      // ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeTaskModal() {
        const modal = document.getElementById("taskModal");
        if (modal) {
          modal.classList.remove("show");
        }
      }

      // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤º
      function showTaskCreationForm(quadrant) {
        // ä»–ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨ã¦éè¡¨ç¤º
        for (let i = 1; i <= 4; i++) {
          const form = document.getElementById(`taskForm${i}`);
          if (form) {
            form.classList.remove("show");
          }
        }

        // æŒ‡å®šã•ã‚ŒãŸè±¡é™ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        const form = document.getElementById(`taskForm${quadrant}`);
        if (form) {
          form.classList.add("show");
          // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          const titleInput = document.getElementById(`taskTitle${quadrant}`);
          if (titleInput) {
            setTimeout(() => titleInput.focus(), 100);
          }
        }
      }

      function hideTaskCreationForm(quadrant) {
        const form = document.getElementById(`taskForm${quadrant}`);
        if (form) {
          form.classList.remove("show");
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          clearTaskForm(quadrant);
        }
      }

      function clearTaskForm(quadrant) {
        const titleInput = document.getElementById(`taskTitle${quadrant}`);
        const notesInput = document.getElementById(`taskNotes${quadrant}`);
        const dueInput = document.getElementById(`taskDue${quadrant}`);

        if (titleInput) titleInput.value = "";
        if (notesInput) notesInput.value = "";
        if (dueInput) dueInput.value = "";
      }

      // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
      async function createTask(quadrant) {
        const titleInput = document.getElementById(`taskTitle${quadrant}`);
        const notesInput = document.getElementById(`taskNotes${quadrant}`);
        const dueInput = document.getElementById(`taskDue${quadrant}`);

        if (!titleInput || !titleInput.value.trim()) {
          showError("ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        const title = titleInput.value.trim();
        const notes = notesInput ? notesInput.value.trim() : "";
        const due = dueInput ? dueInput.value : "";

        try {
          // å¯¾å¿œã™ã‚‹Google Tasksãƒªã‚¹ãƒˆã‚’å–å¾—
          const targetListTitle = getTaskListTitleFromQuadrant(
            quadrant.toString()
          );
          if (!targetListTitle) {
            showError("è±¡é™ã«å¯¾å¿œã™ã‚‹ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
          }

          // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—
          const taskListsResponse = await gapi.client.tasks.tasklists.list({
            maxResults: 100,
          });

          if (!taskListsResponse.result.items) {
            showError("ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            return;
          }

          // å¯¾è±¡ã®ãƒªã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
          let targetList = taskListsResponse.result.items.find(
            (list) => list.title === targetListTitle
          );

          // ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if (!targetList) {
            const createResponse = await gapi.client.tasks.tasklists.insert({
              resource: {
                title: targetListTitle,
              },
            });
            targetList = createResponse.result;
          }

          // ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
          const taskResource = {
            title: title,
          };

          if (notes) {
            taskResource.notes = notes;
          }

          if (due) {
            // æ—¥ä»˜ã‚’RFC3339å½¢å¼ã«å¤‰æ›
            const dueDate = new Date(due);
            taskResource.due = dueDate.toISOString();
          }

          const createTaskResponse = await gapi.client.tasks.tasks.insert({
            tasklist: targetList.id,
            resource: taskResource,
          });

          // ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ã‚¹ã‚¯é…åˆ—ã«è¿½åŠ 
          const newTask = {
            ...createTaskResponse.result,
            taskListId: targetList.id,
            taskListTitle: targetList.title,
          };

          tasks.push(newTask);

          // è±¡é™æƒ…å ±ã‚’ä¿å­˜
          taskQuadrants[newTask.id] = quadrant.toString();
          saveQuadrantsToStorage();

          // è¡¨ç¤ºã‚’æ›´æ–°
          displayTasks();

          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚¯ãƒªã‚¢
          hideTaskCreationForm(quadrant);

          showSuccess("ã‚¿ã‚¹ã‚¯ãŒä½œæˆã•ã‚Œã¾ã—ãŸ");
        } catch (error) {
          showError(
            "ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + (error.message || error.toString())
          );
          console.error("ã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      // ã‚¿ã‚¹ã‚¯ç·¨é›†æ©Ÿèƒ½
      function startEditTask(task) {
        // ä»–ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨ã¦éè¡¨ç¤º
        document.querySelectorAll(".task-edit-form.show").forEach((form) => {
          form.classList.remove("show");
          const taskItem = form.closest(".task-item");
          if (taskItem) {
            taskItem.classList.remove("editing");
          }
        });

        // æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        const editForm = document.getElementById(`editForm-${task.id}`);
        const taskItem = editForm.closest(".task-item");

        if (editForm && taskItem) {
          editForm.classList.add("show");
          taskItem.classList.add("editing");

          // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          const titleInput = document.getElementById(`editTitle-${task.id}`);
          if (titleInput) {
            setTimeout(() => titleInput.focus(), 100);
          }
        }
      }

      function cancelEditTask(taskId) {
        const editForm = document.getElementById(`editForm-${taskId}`);
        const taskItem = editForm.closest(".task-item");

        if (editForm && taskItem) {
          editForm.classList.remove("show");
          taskItem.classList.remove("editing");
        }
      }

      async function saveEditTask(taskId) {
        const titleInput = document.getElementById(`editTitle-${taskId}`);
        const notesInput = document.getElementById(`editNotes-${taskId}`);
        const dueInput = document.getElementById(`editDue-${taskId}`);

        if (!titleInput || !titleInput.value.trim()) {
          showError("ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        const title = titleInput.value.trim();
        const notes = notesInput ? notesInput.value.trim() : "";
        const due = dueInput ? dueInput.value : "";

        try {
          // å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹
          const task = tasks.find((t) => t.id === taskId);
          if (!task) {
            showError("ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
          }

          // Google Tasksã§ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
          const updateResource = {
            id: taskId,
            title: title,
          };

          if (notes) {
            updateResource.notes = notes;
          }

          if (due) {
            const dueDate = new Date(due);
            updateResource.due = dueDate.toISOString();
          }

          await gapi.client.tasks.tasks.update({
            tasklist: task.taskListId,
            task: taskId,
            resource: updateResource,
          });

          // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ã‚¹ã‚¯é…åˆ—ã‚‚æ›´æ–°
          const taskIndex = tasks.findIndex((t) => t.id === taskId);
          if (taskIndex !== -1) {
            tasks[taskIndex] = {
              ...tasks[taskIndex],
              title: title,
              notes: notes,
              due: due ? new Date(due).toISOString() : undefined,
            };
          }

          // è¡¨ç¤ºã‚’æ›´æ–°
          displayTasks();

          showSuccess("ã‚¿ã‚¹ã‚¯ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ");
        } catch (error) {
          showError(
            "ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (error.message || error.toString())
          );
          console.error("ã‚¿ã‚¹ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      function showSuccess(message) {
        const errorArea = document.getElementById("errorArea");
        errorArea.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px; text-align: center;">${message}</div>`;
        errorArea.style.display = "block";
        setTimeout(() => {
          errorArea.style.display = "none";
        }, 3000);
      }

      function showError(message) {
        const errorArea = document.getElementById("errorArea");
        errorArea.innerHTML = `<div class="error">${message}</div>`;
        errorArea.style.display = "block";
        setTimeout(() => {
          errorArea.style.display = "none";
        }, 5000);
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      window.onload = function () {
        // Google API ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€
        const gapiScript = document.createElement("script");
        gapiScript.src = "https://apis.google.com/js/api.js";
        gapiScript.onload = () => {
          if (typeof gapi !== "undefined") {
            onGapiLoaded();
          } else {
            showError("Google API ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        };
        gapiScript.onerror = () => {
          showError(
            "Google API ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          );
        };
        document.head.appendChild(gapiScript);

        const gisScript = document.createElement("script");
        gisScript.src = "https://accounts.google.com/gsi/client";
        gisScript.onload = () => {
          if (typeof google !== "undefined" && google.accounts) {
            onGisLoaded();
          } else {
            showError(
              "Google Identity Services ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
            );
          }
        };
        gisScript.onerror = () => {
          showError(
            "Google Identity Services ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          );
        };
        document.head.appendChild(gisScript);

        // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        setupTaskFormKeyboardEvents();
      };

      // ã‚¿ã‚¹ã‚¯ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      function setupTaskFormKeyboardEvents() {
        for (let i = 1; i <= 4; i++) {
          const titleInput = document.getElementById(`taskTitle${i}`);
          if (titleInput) {
            titleInput.addEventListener("keydown", function (e) {
              // IMEå¤‰æ›ä¸­ã®å ´åˆã¯Enterã‚­ãƒ¼ã‚’ç„¡è¦–
              if (e.key === "Enter" && !e.isComposing) {
                e.preventDefault();
                createTask(i);
              } else if (e.key === "Escape") {
                e.preventDefault();
                hideTaskCreationForm(i);
              }
            });

            // compositionend ã‚¤ãƒ™ãƒ³ãƒˆã§IMEå¤‰æ›çµ‚äº†ã‚’æ¤œçŸ¥
            titleInput.addEventListener("compositionend", function (e) {
              // å¤‰æ›çµ‚äº†å¾Œã®Enterã‚­ãƒ¼ã¯ç„¡è¦–ã™ã‚‹ãŸã‚ã€ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
              setTimeout(() => {
                titleInput.dataset.composing = "false";
              }, 10);
            });

            titleInput.addEventListener("compositionstart", function (e) {
              titleInput.dataset.composing = "true";
            });
          }
        }
      }
    </script>
  </body>
</html>
